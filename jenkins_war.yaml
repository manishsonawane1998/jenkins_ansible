---
 - hosts: webserver
   become: yes
   become_user: ubuntu
   vars:
     bucketname: manishbucket9898
   tasks:
     - name: Create new bucket
       aws_s3:
         bucket: "{{ bucketname }}"
         mode: create
         region: us-east-1

     - name: printing current date and time
       debug:
         msg: "{{ '%Y-%m-%d  %H:%M:%S' | strftime }}"

     - name: Sleep for 5 seconds and timeout
       wait_for:
         delay: 5
         timeout: 0
         
     - name: printing current date and time
       debug:
         msg: "{{ '%Y-%m-%d  %H:%M:%S' | strftime }}"

     - name: coping war file for backup
       copy:
         src: /var/lib/jenkins/workspace/test3/webapp/target/webapp.war
         dest: "/home/ubuntu/playbooks/backup/backup-{{ '%Y-%m-%d-%H:%M:%S' | strftime }}.war"

     - name: Sleep for 5 seconds and timeout
       wait_for:
         delay: 5
         timeout: 0

     - name: printing current date and time
       debug:
         msg: "{{ '%Y-%m-%d  %H:%M:%S' | strftime }}"

     - name: convert .war file into zip format
       command: "mv /home/ubuntu/playbooks/backup/backup-{{ '%Y-%m-%d-%H:%M:%S' | strftime }}.war /home/ubuntu/playbooks/backup/backup-{{ '%Y-%m-%d-%H:%M:%S' | strftime }}.zip"

     - name: Sleep for 5 seconds and timeout
       wait_for:
         delay: 5
         timeout: 0

     - name: printing current date and time
       debug:
         msg: "{{ '%Y-%m-%d  %H:%M:%S' | strftime }}"

     - name: uploading zip backup file to s3 bucket
       aws_s3:
         bucket: "{{ bucketname }}"
         object: backup-{{ '%Y-%m-%d-%H:%M:%S' | strftime }}.zip
         src: "/home/ubuntu/playbooks/backup/backup-{{ '%Y-%m-%d-%H:%M:%S' | strftime }}.zip"
         mode: put

     - name: Sleep for 5 seconds and timeout
       wait_for:
         delay: 5
         timeout: 0

     - name: printing current date and time
       debug:
         msg: "{{ '%Y-%m-%d  %H:%M:%S' | strftime }}"

     - name: downloading backup file to local machine
       aws_s3:
         bucket: "{{ bucketname }}"
         object: backup-{{ '%Y-%m-%d  %H:%M:%S' | strftime }}.zip
         dest: "/home/ubuntu/playbooks/download/backup-{{ '%Y-%m-%d-%H:%M:%S' | strftime }}.zip"
         mode: get

     - name: Sleep for 5 seconds and timeout
       wait_for:
         delay: 5
         timeout: 0

     - name: printing current date and time
       debug:
         msg: "{{ '%Y-%m-%d  %H:%M:%S' | strftime }}"

     - name: convert zip format to orignal .war format
       command: "mv /home/ubuntu/playbooks/download/backup-{{ '%Y-%m-%d-%H:%M:%S' | strftime }}.zip /home/ubuntu/playbooks/download/backup-{{ '%Y-%m-%d-%H:%M:%S' | strftime }}.war"

     - name: Sleep for 5 seconds and timeout
       wait_for:
         delay: 5
         timeout: 0

     - name: printing current date and time
       debug:
         msg: "{{ '%Y-%m-%d  %H:%M:%S' | strftime }}"

     - name: copy war into tomcat servers
       copy:
         src: /home/ubuntu/playbooks/download/backup{{ '%Y-%m-%d-%H:%M:%S' | strftime }}.war
         dest: /opt/tomcat/webapps/webapp.war
       notify: restart tomcat

   handlers:
     - name: restart tomcat
       command: "sudo systemctl restart tomcat"
